{"version":3,"sources":["../../../../src/commands/eas-build/build/action.ts"],"names":["buildAction","projectDir","options","platforms","Object","values","BuildCommandPlatform","platform","profile","includes","Error","map","p","log","chalk","bold","join","easConfig","EasJsonReader","readAsync","ctx","createBuilderContextAsync","nonInteractive","parent","skipCredentialsCheck","skipProjectConfiguration","projectId","user","accountName","projectName","scheduledBuilds","startBuildsAsync","newLine","wait","builds","waitForBuildEndAsync","i","buildId","eas","ALL","UserManager","ensureLoggedInAsync","exp","skipSDKVersionRequirement","owner","username","slug","client","ApiV2","clientForUser","ANDROID","builder","AndroidBuilder","startBuildAsync","push","IOS","iOSBuilder","tarPath","path","os","tmpdir","setupAsync","ensureCredentialsAsync","configureProjectAsync","fileSize","archiveUrl","UploadType","TURTLE_PROJECT_SOURCES","job","prepareJobAsync","platformDisplayNames","postAsync","fs","remove","buildIds","timeoutSec","intervalSec","spinner","start","time","Date","getTime","endTime","Promise","all","getAsync","err","length","status","BuildStatus","FINISHED","succeed","IN_QUEUE","text","IN_PROGRESS","ERRORED","fail","warn","filter","build","inQueue","inProgress","errored","finished","unknownState","red","green"],"mappings":"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","sourcesContent":["import { getConfig } from '@expo/config';\nimport { ApiV2, User, UserManager } from '@expo/xdl';\nimport { build } from '@hapi/joi';\nimport chalk from 'chalk';\nimport delayAsync from 'delay-async';\nimport fs from 'fs-extra';\nimport ora from 'ora';\nimport os from 'os';\nimport path from 'path';\nimport { v4 as uuidv4 } from 'uuid';\n\nimport { EasConfig, EasJsonReader } from '../../../easJson';\nimport log from '../../../log';\nimport { ensureProjectExistsAsync } from '../../../projects';\nimport { UploadType, uploadAsync } from '../../../uploads';\nimport { createProgressTracker } from '../../utils/progress';\nimport { platformDisplayNames } from '../constants';\nimport { Build, BuildCommandPlatform, BuildStatus } from '../types';\nimport AndroidBuilder from './builders/AndroidBuilder';\nimport iOSBuilder from './builders/iOSBuilder';\nimport { Builder, BuilderContext } from './types';\nimport {\n  ensureGitRepoExistsAsync,\n  ensureGitStatusIsCleanAsync,\n  makeProjectTarballAsync,\n} from './utils/git';\nimport { printBuildResults, printLogsUrls } from './utils/misc';\n\ninterface BuildOptions {\n  platform: BuildCommandPlatform;\n  skipCredentialsCheck?: boolean; // TODO: noop for now\n  skipProjectConfiguration?: boolean;\n  wait?: boolean;\n  profile: string;\n  parent?: {\n    nonInteractive: boolean;\n  };\n}\n\nasync function buildAction(projectDir: string, options: BuildOptions): Promise<void> {\n  const platforms = Object.values(BuildCommandPlatform);\n\n  const { platform, profile } = options;\n  if (!platform || !platforms.includes(platform)) {\n    throw new Error(\n      `-p/--platform is required, valid platforms: ${platforms\n        .map(p => log.chalk.bold(p))\n        .join(', ')}`\n    );\n  }\n\n  await ensureGitRepoExistsAsync();\n  await ensureGitStatusIsCleanAsync();\n\n  const easConfig: EasConfig = await new EasJsonReader(projectDir, platform).readAsync(profile);\n  const ctx = await createBuilderContextAsync(projectDir, easConfig, {\n    platform,\n    nonInteractive: options.parent?.nonInteractive,\n    skipCredentialsCheck: options?.skipCredentialsCheck,\n    skipProjectConfiguration: options?.skipProjectConfiguration,\n  });\n  const projectId = await ensureProjectExistsAsync(ctx.user, {\n    accountName: ctx.accountName,\n    projectName: ctx.projectName,\n  });\n  const scheduledBuilds = await startBuildsAsync(ctx, projectId);\n  log.newLine();\n  await printLogsUrls(ctx.accountName, scheduledBuilds);\n  log.newLine();\n\n  if (options.wait) {\n    const builds = await waitForBuildEndAsync(\n      ctx,\n      projectId,\n      scheduledBuilds.map(i => i.buildId)\n    );\n    printBuildResults(builds);\n  }\n}\n\nasync function createBuilderContextAsync(\n  projectDir: string,\n  eas: EasConfig,\n  {\n    platform = BuildCommandPlatform.ALL,\n    nonInteractive = false,\n    skipCredentialsCheck = false,\n    skipProjectConfiguration = false,\n  }: {\n    platform?: BuildCommandPlatform;\n    nonInteractive?: boolean;\n    skipCredentialsCheck?: boolean;\n    skipProjectConfiguration?: boolean;\n  }\n): Promise<BuilderContext> {\n  const user: User = await UserManager.ensureLoggedInAsync();\n  const { exp } = getConfig(projectDir, { skipSDKVersionRequirement: true });\n  const accountName = exp.owner || user.username;\n  const projectName = exp.slug;\n\n  return {\n    eas,\n    projectDir,\n    user,\n    accountName,\n    projectName,\n    exp,\n    platform,\n    nonInteractive,\n    skipCredentialsCheck,\n    skipProjectConfiguration,\n  };\n}\n\nasync function startBuildsAsync(\n  ctx: BuilderContext,\n  projectId: string\n): Promise<\n  { platform: BuildCommandPlatform.ANDROID | BuildCommandPlatform.IOS; buildId: string }[]\n> {\n  const client = ApiV2.clientForUser(ctx.user);\n  const scheduledBuilds: {\n    platform: BuildCommandPlatform.ANDROID | BuildCommandPlatform.IOS;\n    buildId: string;\n  }[] = [];\n  if ([BuildCommandPlatform.ANDROID, BuildCommandPlatform.ALL].includes(ctx.platform)) {\n    const builder = new AndroidBuilder(ctx);\n    const buildId = await startBuildAsync(client, builder, projectId);\n    scheduledBuilds.push({ platform: BuildCommandPlatform.ANDROID, buildId });\n  }\n  if ([BuildCommandPlatform.IOS, BuildCommandPlatform.ALL].includes(ctx.platform)) {\n    const builder = new iOSBuilder(ctx);\n    const buildId = await startBuildAsync(client, builder, projectId);\n    scheduledBuilds.push({ platform: BuildCommandPlatform.IOS, buildId });\n  }\n  return scheduledBuilds;\n}\n\nasync function startBuildAsync(\n  client: ApiV2,\n  builder: Builder,\n  projectId: string\n): Promise<string> {\n  const tarPath = path.join(os.tmpdir(), `${uuidv4()}.tar.gz`);\n  try {\n    await builder.setupAsync();\n    await builder.ensureCredentialsAsync();\n    if (!builder.ctx.skipProjectConfiguration) {\n      await builder.configureProjectAsync();\n    }\n\n    const fileSize = await makeProjectTarballAsync(tarPath);\n\n    log('Uploading project to AWS S3');\n    const archiveUrl = await uploadAsync(\n      UploadType.TURTLE_PROJECT_SOURCES,\n      tarPath,\n      createProgressTracker(fileSize)\n    );\n\n    const job = await builder.prepareJobAsync(archiveUrl);\n    log(`Starting ${platformDisplayNames[job.platform]} build`);\n    const { buildId } = await client.postAsync(`projects/${projectId}/builds`, {\n      job: job as any,\n    });\n    return buildId;\n  } finally {\n    await fs.remove(tarPath);\n  }\n}\n\nasync function waitForBuildEndAsync(\n  ctx: BuilderContext,\n  projectId: string,\n  buildIds: string[],\n  { timeoutSec = 1800, intervalSec = 30 } = {}\n): Promise<(Build | null)[]> {\n  const client = ApiV2.clientForUser(ctx.user);\n  log('Waiting for build to complete. You can press Ctrl+C to exit.');\n  const spinner = ora().start();\n  let time = new Date().getTime();\n  const endTime = time + timeoutSec * 1000;\n  while (time <= endTime) {\n    const builds: (Build | null)[] = await Promise.all(\n      buildIds.map(buildId => {\n        try {\n          return client.getAsync(`projects/${projectId}/builds/${buildId}`);\n        } catch (err) {\n          return null;\n        }\n      })\n    );\n    if (builds.length === 1) {\n      switch (builds[0]?.status) {\n        case BuildStatus.FINISHED:\n          spinner.succeed('Build finished.');\n          return builds;\n        case BuildStatus.IN_QUEUE:\n          spinner.text = 'Build queued...';\n          break;\n        case BuildStatus.IN_PROGRESS:\n          spinner.text = 'Build in progress...';\n          break;\n        case BuildStatus.ERRORED:\n          spinner.fail('Build failed.');\n          throw new Error(`Standalone build failed!`);\n        default:\n          spinner.warn('Unknown status.');\n          throw new Error(`Unknown status: ${builds} - aborting!`);\n      }\n    } else {\n      if (builds.filter(build => build?.status === BuildStatus.FINISHED).length === builds.length) {\n        spinner.succeed('All build have finished.');\n        return builds;\n      } else if (\n        builds.filter(build =>\n          build?.status ? [BuildStatus.FINISHED, BuildStatus.ERRORED].includes(build.status) : false\n        ).length === builds.length\n      ) {\n        spinner.fail('Some of the builds failed.');\n        return builds;\n      } else {\n        const inQueue = builds.filter(build => build?.status === BuildStatus.IN_QUEUE).length;\n        const inProgress = builds.filter(build => build?.status === BuildStatus.IN_PROGRESS).length;\n        const errored = builds.filter(build => build?.status === BuildStatus.ERRORED).length;\n        const finished = builds.filter(build => build?.status === BuildStatus.FINISHED).length;\n        const unknownState = builds.length - inQueue - inProgress - errored - finished;\n        spinner.text = [\n          inQueue && `Builds in queue: ${inQueue}`,\n          inProgress && `Builds in progress: ${inProgress}`,\n          errored && chalk.red(`Builds failed: ${errored}`),\n          finished && chalk.green(`Builds finished: ${finished}`),\n          unknownState && chalk.red(`Builds in unknown state: ${unknownState}`),\n        ]\n          .filter(i => i)\n          .join('\\t');\n      }\n    }\n    time = new Date().getTime();\n    await delayAsync(intervalSec * 1000);\n  }\n  spinner.warn('Timed out.');\n  throw new Error(\n    'Timeout reached! It is taking longer than expected to finish the build, aborting...'\n  );\n}\n\nexport default buildAction;\n"],"file":"action.js"}