{"version":3,"sources":["../../../../../src/commands/eas-build/build/builders/iOSBuilder.ts"],"names":["iOSBuilder","constructor","ctx","eas","builds","ios","Error","buildProfile","prepareJobAsync","archiveUrl","workflow","Workflow","Generic","prepareGenericJobAsync","Managed","prepareManagedJobAsync","ensureCredentialsAsync","shouldLoadCredentials","bundleIdentifier","projectDir","exp","provider","iOSCredentialsProvider","projectName","accountName","initAsync","credentialsSource","nonInteractive","credentials","getCredentialsAsync","setupAsync","scheme","resolveScheme","configureProjectAsync","spinner","profileName","ProvisioningProfileUtils","readProfileName","provisioningProfile","appleTeam","readAppleTeam","IOSConfig","BundleIdenitifer","setBundleIdentifierForPbxproj","ProvisioningProfile","setProvisioningProfileForPbxproj","appleTeamId","teamId","gitUtils","ensureGitStatusIsCleanAsync","succeed","err","DirtyGitTreeError","log","newLine","reviewAndCommitChangesAsync","chalk","green","figures","tick","e","fail","prepareJobCommonAsync","secrets","provisioningProfileBase64","distributionCertificate","dataBase64","certP12","password","certPassword","platform","Platform","iOS","projectUrl","type","BuildType","artifactPath","_buildProfile","packageJson","example","manifest","buildType","schemes","Scheme","getSchemesFromXcodeproj","length","sortedSchemes","bold","join","withoutTvOS","filter","i","includes","selectedScheme","name","message","choices","map","title","value"],"mappings":"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","sourcesContent":["import { BuildType, Job, Platform, iOS, sanitizeJob } from '@expo/build-tools';\nimport { IOSConfig } from '@expo/config';\nimport chalk from 'chalk';\nimport figures from 'figures';\nimport sortBy from 'lodash/sortBy';\nimport ora from 'ora';\n\nimport iOSCredentialsProvider, {\n  iOSCredentials,\n} from '../../../../credentials/provider/iOSCredentialsProvider';\nimport * as ProvisioningProfileUtils from '../../../../credentials/utils/provisioningProfile';\nimport {\n  Workflow,\n  iOSBuildProfile,\n  iOSGenericBuildProfile,\n  iOSManagedBuildProfile,\n} from '../../../../easJson';\nimport log from '../../../../log';\nimport prompts from '../../../../prompts';\nimport { ensureCredentialsAsync } from '../credentials';\nimport { Builder, BuilderContext } from '../types';\nimport * as gitUtils from '../utils/git';\nimport { getBundleIdentifier } from '../utils/ios';\n\ninterface CommonJobProperties {\n  platform: Platform.iOS;\n  projectUrl: string;\n  secrets?: {\n    provisioningProfileBase64: string;\n    distributionCertificate: {\n      dataBase64: string;\n      password: string;\n    };\n  };\n}\n\nclass iOSBuilder implements Builder {\n  private credentials?: iOSCredentials;\n  private buildProfile: iOSBuildProfile;\n  private scheme?: string;\n\n  constructor(public readonly ctx: BuilderContext) {\n    if (!ctx.eas.builds.ios) {\n      throw new Error(\"missing ios configuration, shouldn't happen\");\n    }\n    this.buildProfile = ctx.eas.builds.ios;\n  }\n\n  public async prepareJobAsync(archiveUrl: string): Promise<Job> {\n    if (this.buildProfile.workflow === Workflow.Generic) {\n      return sanitizeJob(await this.prepareGenericJobAsync(archiveUrl, this.buildProfile));\n    } else if (this.buildProfile.workflow === Workflow.Managed) {\n      return sanitizeJob(await this.prepareManagedJobAsync(archiveUrl, this.buildProfile));\n    } else {\n      throw new Error(\"Unknown workflow. Shouldn't happen\");\n    }\n  }\n\n  public async ensureCredentialsAsync(): Promise<void> {\n    if (!this.shouldLoadCredentials()) {\n      return;\n    }\n    const bundleIdentifier = await getBundleIdentifier(this.ctx.projectDir, this.ctx.exp);\n    const provider = new iOSCredentialsProvider(this.ctx.projectDir, {\n      projectName: this.ctx.projectName,\n      accountName: this.ctx.accountName,\n      bundleIdentifier,\n    });\n    await provider.initAsync();\n    const credentialsSource = await ensureCredentialsAsync(\n      provider,\n      this.buildProfile.workflow,\n      this.buildProfile.credentialsSource,\n      this.ctx.nonInteractive\n    );\n    this.credentials = await provider.getCredentialsAsync(credentialsSource);\n  }\n\n  public async setupAsync(): Promise<void> {\n    if (this.buildProfile.workflow === Workflow.Generic) {\n      this.scheme = this.buildProfile.scheme ?? (await this.resolveScheme());\n    }\n  }\n\n  public async configureProjectAsync(): Promise<void> {\n    if (this.buildProfile.workflow !== Workflow.Generic) {\n      return;\n    }\n\n    // TODO: add simulator flow\n    // assuming we're building for app store\n    if (!this.credentials) {\n      throw new Error('Call ensureCredentialsAsync first!');\n    }\n\n    const bundleIdentifier = await getBundleIdentifier(this.ctx.projectDir, this.ctx.exp);\n\n    const spinner = ora('Configuring the Xcode project');\n\n    const profileName = ProvisioningProfileUtils.readProfileName(\n      this.credentials.provisioningProfile\n    );\n    const appleTeam = ProvisioningProfileUtils.readAppleTeam(this.credentials.provisioningProfile);\n\n    const { projectDir } = this.ctx;\n    IOSConfig.BundleIdenitifer.setBundleIdentifierForPbxproj(projectDir, bundleIdentifier, false);\n    IOSConfig.ProvisioningProfile.setProvisioningProfileForPbxproj(projectDir, {\n      profileName,\n      appleTeamId: appleTeam.teamId,\n    });\n\n    try {\n      await gitUtils.ensureGitStatusIsCleanAsync();\n      spinner.succeed();\n    } catch (err) {\n      if (err instanceof gitUtils.DirtyGitTreeError) {\n        spinner.succeed('We configured the Xcode project to build it on the Expo servers');\n        log.newLine();\n\n        try {\n          await gitUtils.reviewAndCommitChangesAsync('Configure Xcode project', {\n            nonInteractive: this.ctx.nonInteractive,\n          });\n\n          log(`${chalk.green(figures.tick)} Successfully committed the configuration changes.`);\n        } catch (e) {\n          throw new Error(\n            \"Aborting, run the build command once you're ready. Make sure to commit any changes you've made.\"\n          );\n        }\n      } else {\n        spinner.fail();\n        throw err;\n      }\n    }\n  }\n\n  private async prepareJobCommonAsync(archiveUrl: string): Promise<Partial<CommonJobProperties>> {\n    const secrets = this.credentials\n      ? {\n          secrets: {\n            provisioningProfileBase64: this.credentials.provisioningProfile,\n            distributionCertificate: {\n              dataBase64: this.credentials.distributionCertificate.certP12,\n              password: this.credentials.distributionCertificate.certPassword,\n            },\n          },\n        }\n      : {};\n\n    return {\n      platform: Platform.iOS,\n      projectUrl: archiveUrl,\n      ...secrets,\n    };\n  }\n\n  private async prepareGenericJobAsync(\n    archiveUrl: string,\n    buildProfile: iOSGenericBuildProfile\n  ): Promise<Partial<iOS.GenericJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Generic,\n      scheme: this.scheme,\n      artifactPath: buildProfile.artifactPath,\n    };\n  }\n\n  private async prepareManagedJobAsync(\n    archiveUrl: string,\n    _buildProfile: iOSManagedBuildProfile\n  ): Promise<Partial<iOS.ManagedJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Managed,\n      packageJson: { example: 'packageJson' },\n      manifest: { example: 'manifest' },\n    };\n  }\n\n  private shouldLoadCredentials(): boolean {\n    return (\n      (this.buildProfile.workflow === Workflow.Managed &&\n        this.buildProfile.buildType !== 'simulator') ||\n      this.buildProfile.workflow === Workflow.Generic\n    );\n  }\n\n  private async resolveScheme(): Promise<string> {\n    const schemes = IOSConfig.Scheme.getSchemesFromXcodeproj(this.ctx.projectDir);\n    if (schemes.length === 1) {\n      return schemes[0];\n    }\n\n    const sortedSchemes = sortBy(schemes);\n    log.newLine();\n    log(\n      `We've found multiple schemes in your Xcode project: ${log.chalk.bold(\n        sortedSchemes.join(', ')\n      )}`\n    );\n    log(\n      `You can specify the scheme you want to build at ${log.chalk.bold(\n        'builds.ios.PROFILE_NAME.scheme'\n      )} in eas.json.`\n    );\n    if (this.ctx.nonInteractive) {\n      const withoutTvOS = sortedSchemes.filter(i => !i.includes('tvOS'));\n      const scheme = withoutTvOS.length > 0 ? withoutTvOS[0] : sortedSchemes[0];\n      log(\n        `You've run Expo CLI in non-interactive mode, choosing the ${log.chalk.bold(\n          scheme\n        )} scheme.`\n      );\n      log.newLine();\n      return scheme;\n    } else {\n      const { selectedScheme } = await prompts({\n        type: 'select',\n        name: 'selectedScheme',\n        message: 'Which scheme would you like to build now?',\n        choices: sortedSchemes.map(scheme => ({ title: scheme, value: scheme })),\n      });\n      log.newLine();\n      return selectedScheme as string;\n    }\n  }\n}\n\nexport default iOSBuilder;\n"],"file":"iOSBuilder.js"}